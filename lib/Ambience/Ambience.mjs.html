<html>
  <head>
    <base href="../.."/>
    <title>x-elements - Ambience.mjs</title>

    <link rel="stylesheet" href="public/github-markdown.min-05fea8df8ec68cb6c27337f6db65733e.css">
    <link rel="stylesheet" href="public/highlight-c281e701b2830b095c67417cd9a7b210.css">
    <link rel="stylesheet" href="public/style-aea3468ccb7ee0c3c4c2b5d339fc989e.css">
    <link rel="stylesheet" href="public/all-cc69a8b8824029ae06797ee01a3cc5c8.css">

    <!-- <style>
      @font-face {
        font-family: "EmojiSymbols";
        src: url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.eot");
        src: url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.eot?#iefix")format("embedded-opentype"),
        url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.woff2")format("woff2"),
        url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.woff")format("woff"),
        url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.ttf")format("truetype"),
        url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.svg#EmojiSymbols-Regular")format("svg");
      }

    </style> -->

    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" /> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/segoe-fonts@1.0.1/segoe-fonts.min.css"> -->

    <!-- <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Emoji:wght@300..700&display=swap" rel="stylesheet"> -->

    <script src="public/plugins/core/example/ExampleViewer.js"></script>
              <script type="importmap">
              {
                "imports": {
                  "x-elements": "./public/index.mjs"
                }
              }
            </script>
              <script src="public/index.mjs" type="module"></script>
            
  </head>
  <body class="markdown-body flex-column">
    <div class="header flex">
      <a class="header-brand" href="./index.html">x-elements</a>
      
<ul class="menu flex align-center justify-center">
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Select.html"
        
        
          role="button"
          
          aria-expanded="false"
        
      >
        Components
      </a>
      
    </li>
    
  
</ul>
      <nav class="links">
        
          
            
              <a href="https://github.com/benignware-labs/x-elements.git">
                
                <i class="fa-brands fa-github"></i>
                <!--<label>github</label>-->
              </a>
            
          
        
      </nav>
    </div>
      
      

<main class="flex-grow flex h-100">
  <div class="sidebar sidebar-left border-right mr-2 flex-noshrink">
  
<ul class="menu">
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Select.html"
        
        
          role="button"
          
          aria-expanded="false"
        
      >
        Components
      </a>
      
        
<ul class="menu">
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Select.html"
        
        
      >
        Select
      </a>
      
    </li>
    
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Preloader.html"
        
        
      >
        Preloader
      </a>
      
    </li>
    
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Panel.html"
        
        
      >
        Panel
      </a>
      
    </li>
    
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/MediaControls.html"
        
        
      >
        MediaControls
      </a>
      
    </li>
    
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Ambience.html"
        
        
      >
        Ambience
      </a>
      
    </li>
    
  
</ul>
      
    </li>
    
  
</ul>
</div>
  <div class="flex-grow">
    <div class="container py-4">
      <h1>Source: Ambience.mjs</h1>
      <p>
        lib/Ambience/Ambience.mjs
      </p>
      
      <pre><code class="hljs"><span class="hljs-keyword">const</span> MEDIA_TAGS = [<span class="hljs-string">&#x27;IMG&#x27;</span>, <span class="hljs-string">&#x27;VIDEO&#x27;</span>];

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Ambience</span> <span class="hljs-title">extends</span> <span class="hljs-title">HTMLElement</span> {
  #assignedChildren;
  #mutationObservers;
  #mediaElements;
  #displayElements;
  #backdrop;
  #backdropBody;

  static observedAttributes = [<span class="hljs-string">&#x27;for&#x27;</span>];

  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">super</span>();

    <span class="hljs-keyword">this</span>.handleMutation = <span class="hljs-keyword">this</span>.handleMutation.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handleSlotChange = <span class="hljs-keyword">this</span>.handleSlotChange.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handleResize = <span class="hljs-keyword">this</span>.handleResize.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handleLoad = <span class="hljs-keyword">this</span>.handleLoad.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.attachShadow({ mode: <span class="hljs-string">&#x27;open&#x27;</span> });

    <span class="hljs-keyword">this</span>.shadowRoot.innerHTML = `
      &lt;style&gt;
        <span class="hljs-comment">/* Add your styling here */</span>
        :host {
          display: contents;
          position: relative;
          transform-style: preserve-<span class="hljs-number">3d</span>;
           
        }

        slot {
          display: block;
          transform-style: preserve-<span class="hljs-number">3d</span>;
        }

        :host::part(backdrop) {
          position: relative;
          z-index: -<span class="hljs-number">1</span>;
          transform : translate3d ( <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span> ) ;
          transform-style: preserve-<span class="hljs-number">3d</span>;
          
          <span class="hljs-comment">/*filter: contrast(2) blur(3.5rem) opacity(0.5) brightness(2.7);*/</span>
          filter: blur(<span class="hljs-number">3.</span>5rem);
          <span class="hljs-comment">/*pointer-events: none;*/</span>
          transform: translate3d(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
        }
        
        :host::part(backdrop-body) {
          transform: translate3d(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
          transform-style: preserve-<span class="hljs-number">3d</span>;
        }

        <span class="hljs-comment">/*:host::part(body) {
          position: relative;
          overflow: auto;
          height: 300px;
        }*/</span>
      &lt;/style&gt;
      &lt;div part=<span class="hljs-string">&quot;body&quot;</span>&gt;
        &lt;div part=<span class="hljs-string">&quot;backdrop&quot;</span>&gt;
          &lt;div part=<span class="hljs-string">&quot;backdrop-body&quot;</span>&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div part=<span class="hljs-string">&quot;content&quot;</span>&gt;
          &lt;slot&gt;&lt;/slot&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `;

    <span class="hljs-keyword">this</span>.#backdrop = <span class="hljs-keyword">this</span>.shadowRoot.querySelector(<span class="hljs-string">&#x27;[part=&quot;backdrop&quot;]&#x27;</span>);
    <span class="hljs-keyword">this</span>.#backdropBody = <span class="hljs-keyword">this</span>.shadowRoot.querySelector(<span class="hljs-string">&#x27;[part=&quot;backdrop-body&quot;]&#x27;</span>);
    <span class="hljs-keyword">this</span>.#assignedChildren = new Set();
    <span class="hljs-keyword">this</span>.#mediaElements = new Set();
    <span class="hljs-keyword">this</span>.#displayElements = new WeakMap();
    <span class="hljs-keyword">this</span>.#mutationObservers = new WeakMap();
  }

  handleMutation(mutations) {
    mutations.forEach((mutation) =&gt; {
      mutation.addedNodes
        .filter(node =&gt; node.nodeType === <span class="hljs-number">1</span> &amp;&amp; MEDIA_TAGS.includes(node.nodeName))
        .forEach(node =&gt; <span class="hljs-keyword">this</span>.mediaElementAdded(node));
      
       mutation.removedNodes
        .filter(node =&gt; node.nodeType === <span class="hljs-number">1</span> &amp;&amp; MEDIA_TAGS.includes(node.nodeName))
        .forEach(node =&gt; <span class="hljs-keyword">this</span>.mediaElementRemoved(node));
    });
  }

  createDisplayElement(element) {
    let displayElement;
  
    <span class="hljs-keyword">if</span> (element instanceof HTMLMediaElement) {
      <span class="hljs-keyword">const</span> canvas = document.createElement(<span class="hljs-string">&#x27;canvas&#x27;</span>);
      <span class="hljs-keyword">const</span> poster = document.createElement(<span class="hljs-string">&#x27;img&#x27;</span>);

      poster.src = element.poster;
      poster.style.width = <span class="hljs-string">&#x27;100%&#x27;</span>;
      poster.style.height = <span class="hljs-string">&#x27;100%&#x27;</span>;
      poster.style.position = <span class="hljs-string">&#x27;absolute&#x27;</span>;

      canvas.style.width = <span class="hljs-string">&#x27;100%&#x27;</span>;
      canvas.style.height = <span class="hljs-string">&#x27;100%&#x27;</span>;
      canvas.style.position = <span class="hljs-string">&#x27;absolute&#x27;</span>;

      displayElement = document.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);
      
      displayElement.appendChild(canvas);
      displayElement.appendChild(poster);
    }

    <span class="hljs-keyword">if</span> (!displayElement) {
      displayElement = element.cloneNode(<span class="hljs-literal">true</span>);
    }

    displayElement.style.transition = <span class="hljs-string">&#x27;opacity 0.12s&#x27;</span>;

    <span class="hljs-keyword">return</span> displayElement;
  }

  mediaElementAdded(...element) {
    element.forEach(element =&gt; {
      <span class="hljs-keyword">this</span>.#mediaElements.add(element);
      <span class="hljs-keyword">const</span> displayElement = <span class="hljs-keyword">this</span>.createDisplayElement(element);
      <span class="hljs-keyword">this</span>.#backdropBody.appendChild(displayElement);
      <span class="hljs-keyword">this</span>.#displayElements.<span class="hljs-keyword">set</span>(element, displayElement);

      element.addEventListener(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-keyword">this</span>.handleLoad);
    });

    <span class="hljs-keyword">this</span>.render();
  }

  mediaElementRemoved(...element) {
    element.forEach(element =&gt; {
      <span class="hljs-keyword">this</span>.#mediaElements.delete(element);
      <span class="hljs-keyword">this</span>.#backdropBody.removeChild(displayElement);
      <span class="hljs-keyword">this</span>.#displayElements.delete(element);

      element.removeEventListener(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-keyword">this</span>.handleLoad);
    });

    <span class="hljs-keyword">this</span>.render();
  }

  addTargetElement(...elements) {
    elements
      .filter(element =&gt; !<span class="hljs-keyword">this</span>.#assignedChildren.has(element))
      .forEach(element =&gt; {
        <span class="hljs-keyword">this</span>.#assignedChildren.add(element);
        <span class="hljs-keyword">const</span> mutationObserver = new MutationObserver(<span class="hljs-keyword">this</span>.handleMutation);
        
        mutationObserver.observe(element, {
          childList: <span class="hljs-literal">true</span>,
          subtree: <span class="hljs-literal">true</span>
        });

        <span class="hljs-keyword">this</span>.#mutationObservers.<span class="hljs-keyword">set</span>(element, mutationObserver);
      
        <span class="hljs-keyword">const</span> nodes = [...element.querySelectorAll(MEDIA_TAGS.join(<span class="hljs-string">&#x27;, &#x27;</span>))];
        
        <span class="hljs-keyword">if</span> (MEDIA_TAGS.includes(element.nodeName)) {
          nodes.push(element);
        }

        <span class="hljs-keyword">this</span>.mediaElementAdded(...nodes);
      });
  }

  removeTargetElement(...elements) {
    elements
      .filter(element =&gt; <span class="hljs-keyword">this</span>.#assignedChildren.has(element))
      .forEach(element =&gt; {
        <span class="hljs-keyword">const</span> mutationObserver = <span class="hljs-keyword">this</span>.#mutationObservers.<span class="hljs-keyword">get</span>(element);

        mutationObserver.disconnect();

        <span class="hljs-keyword">this</span>.#mutationObservers.delete(element);

        <span class="hljs-keyword">this</span>.#assignedChildren.delete(element);

        <span class="hljs-keyword">if</span> (MEDIA_TAGS.includes(element.nodeName)) {
          <span class="hljs-keyword">this</span>.mediaElementRemoved(element);
        }
      });
  }

  handleSlotChange(e) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasAttribute(<span class="hljs-string">&#x27;for&#x27;</span>)) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> slot = e.target;
    <span class="hljs-keyword">const</span> assignedElements = [...<span class="hljs-keyword">this</span>.#assignedChildren];
    <span class="hljs-keyword">const</span> removedNodes = assignedElements.filter(x =&gt; !slot.assignedElements().includes(x));
    <span class="hljs-keyword">const</span> addedNodes = slot.assignedElements().filter(x =&gt; !assignedElements.includes(x));

    <span class="hljs-keyword">this</span>.addTargetElement(...addedNodes);
    <span class="hljs-keyword">this</span>.removeTargetElement(...removedNodes);
  }

  handleResize() {
    <span class="hljs-keyword">this</span>.render();
  }

  handleLoad(event) {
    console.log(<span class="hljs-string">&#x27;handleLoad&#x27;</span>, event.target.src);
    window.requestAnimationFrame(() =&gt; {
      <span class="hljs-keyword">this</span>.render();
    });
  }

  connectedCallback() {
    <span class="hljs-keyword">const</span> slot = <span class="hljs-keyword">this</span>.shadowRoot.querySelector(<span class="hljs-string">&#x27;slot&#x27;</span>);

    slot.addEventListener(<span class="hljs-string">&#x27;slotchange&#x27;</span>, <span class="hljs-keyword">this</span>.handleSlotChange);
    window.addEventListener(<span class="hljs-string">&#x27;resize&#x27;</span>, <span class="hljs-keyword">this</span>.handleResize);
  }

  detachedCallback() {
    window.removeEventListener(<span class="hljs-string">&#x27;resize&#x27;</span>, <span class="hljs-keyword">this</span>.handleResize);
  }

  <span class="hljs-keyword">get</span> clipArea() {
    let bounds = [...<span class="hljs-keyword">this</span>.#assignedChildren].reduce((bounds, element) =&gt; {
      <span class="hljs-keyword">const</span> elementBounds = element.getBoundingClientRect();

      bounds.top = Math.min(bounds.top, elementBounds.top);
      bounds.left = Math.min(bounds.left, elementBounds.left);
      bounds.bottom = Math.max(bounds.bottom, elementBounds.bottom);
      bounds.right = Math.max(bounds.right, elementBounds.right);
      
      <span class="hljs-keyword">return</span> bounds;
    }, {
      top: Infinity,
      left: Infinity,
      bottom: -Infinity,
      right: -Infinity
    });

    <span class="hljs-comment">// const scrollY = window.scrollY;</span>
    <span class="hljs-comment">// const scrollX = window.scrollX;</span>

    <span class="hljs-comment">// bounds.top = scrollY + Math.max(0, bounds.top);</span>
    <span class="hljs-comment">// bounds.left = scrollX + Math.max(0, bounds.left);</span>
    <span class="hljs-comment">// bounds.bottom = scrollY + Math.min(window.innerHeight, bounds.bottom);</span>
    <span class="hljs-comment">// bounds.right = scrollX + Math.min(window.innerWidth, bounds.right);</span>

    bounds = {
      top: Math.round(bounds.top),
      left: Math.round(bounds.left),
      width: Math.round(bounds.right - bounds.left),
      height: Math.round(bounds.bottom - bounds.top),
      right: Math.round(bounds.right),
      bottom: Math.round(bounds.bottom)
    };

    <span class="hljs-keyword">const</span> targetBounds = <span class="hljs-keyword">this</span>.#backdrop.getBoundingClientRect();

    bounds.top -= targetBounds.top;
    bounds.left -= targetBounds.left;
    bounds.bottom -= targetBounds.top;
    bounds.right -= targetBounds.left;

    <span class="hljs-keyword">return</span> bounds;
  }

  render() {
    <span class="hljs-keyword">const</span> bounds = <span class="hljs-keyword">this</span>.getBoundingClientRect();
    <span class="hljs-keyword">const</span> backdrop = <span class="hljs-keyword">this</span>.#backdrop;
    <span class="hljs-keyword">const</span> targetBounds = backdrop.getBoundingClientRect();

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.#mediaElements.size === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> element of <span class="hljs-keyword">this</span>.#mediaElements) {
      <span class="hljs-comment">// console.log(&#x27;element: &#x27;, element);</span>
      <span class="hljs-comment">// Get the top, left coordinates of two elements</span>
      <span class="hljs-keyword">const</span> style = window.getComputedStyle(element);

      <span class="hljs-comment">// if (style.display === &#x27;none&#x27;) {</span>
      <span class="hljs-comment">//   console.log(&#x27;DISPLAY NONE&#x27;);</span>
      <span class="hljs-comment">//   element.style.display = &#x27;block&#x27;;</span>
      <span class="hljs-comment">// }</span>

      <span class="hljs-keyword">const</span> copyStyles = [<span class="hljs-string">&#x27;filter&#x27;</span>, <span class="hljs-string">&#x27;transition&#x27;</span>, <span class="hljs-string">&#x27;visibility&#x27;</span>];

      let elementBounds = element.getBoundingClientRect();
      

      <span class="hljs-comment">// element.style.display = &#x27;&#x27;;</span>

      <span class="hljs-comment">// Calculate the top and left positions</span>
      <span class="hljs-keyword">const</span> top = elementBounds.top - targetBounds.top;
      <span class="hljs-keyword">const</span> left = elementBounds.left - targetBounds.left;

      <span class="hljs-keyword">const</span> displayElement = <span class="hljs-keyword">this</span>.#displayElements.<span class="hljs-keyword">get</span>(element);

      <span class="hljs-comment">// element.style.opacity = 0.1;</span>
      <span class="hljs-comment">// element.style.outline = &#x27;2px solid red&#x27;;</span>

      displayElement.style.display = <span class="hljs-string">&#x27;block&#x27;</span>;

      displayElement.style.marginLeft = <span class="hljs-string">&#x27;0&#x27;</span>;
      displayElement.style.marginTop = <span class="hljs-string">&#x27;0&#x27;</span>;
      displayElement.style.margin = <span class="hljs-string">&#x27;0&#x27;</span>;

      displayElement.style.position = <span class="hljs-string">&#x27;absolute&#x27;</span>;

      copyStyles.forEach(name =&gt; {
        displayElement.style[name] = style[name];
      });

      <span class="hljs-keyword">if</span> (elementBounds.width &gt; <span class="hljs-number">0</span> &amp;&amp; elementBounds.height &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// displayElement.style.top = `${top}px`;</span>
        <span class="hljs-comment">// displayElement.style.left = `${left}px`;</span>
        displayElement.style.transform = `translate(${left}px, ${top}px)`;

        displayElement.style.width = `${elementBounds.width}px`;
        displayElement.style.height = `${elementBounds.height}px`;
        displayElement.style.opacity = <span class="hljs-number">1</span>;
      } <span class="hljs-keyword">else</span> {
        displayElement.style.opacity = <span class="hljs-number">0</span>;
      }
      <span class="hljs-comment">// displayElement.style.border = &#x27;2px solid green&#x27;;</span>

      <span class="hljs-keyword">if</span> (element instanceof HTMLMediaElement) {
        <span class="hljs-keyword">const</span> canvas = displayElement.querySelector(<span class="hljs-string">&#x27;canvas&#x27;</span>);
        <span class="hljs-keyword">const</span> poster = displayElement.querySelector(<span class="hljs-string">&#x27;img&#x27;</span>);
        
        <span class="hljs-keyword">const</span> isPoster = element.poster &amp;&amp; element.played.length === <span class="hljs-number">0</span>;

        poster.style.display = isPoster ? <span class="hljs-string">&#x27;block&#x27;</span> : <span class="hljs-string">&#x27;none&#x27;</span>;

        <span class="hljs-keyword">if</span> (!isPoster) {
          canvas.width = elementBounds.width;
          canvas.height = elementBounds.height;

          <span class="hljs-keyword">const</span> context = canvas.getContext(<span class="hljs-string">&#x27;2d&#x27;</span>);
          context.drawImage(element, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.width, canvas.height);
        }
      }
    }

    <span class="hljs-keyword">const</span> clipArea = <span class="hljs-keyword">this</span>.clipArea;

    <span class="hljs-keyword">const</span> clipPath = `polygon(${clipArea.left}px ${clipArea.top}px,${clipArea.right}px ${clipArea.top}px,${clipArea.right}px ${clipArea.bottom}px,${clipArea.left}px ${clipArea.bottom}px)`;

    <span class="hljs-comment">// console.log(&#x27;clipPath: &#x27;, clipArea, clipPath);</span>

    <span class="hljs-keyword">this</span>.#backdropBody.style.clipPath = clipPath;
  
    window.requestAnimationFrame(() =&gt; {
      <span class="hljs-keyword">this</span>.render();
    });
  }

  attributeChangedCallback(name, oldValue, newValue) {
    <span class="hljs-keyword">if</span> (oldValue === newValue) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">&#x27;for&#x27;</span>) {
      <span class="hljs-keyword">const</span> targetElement = document.querySelector(`#${newValue}`);

      <span class="hljs-keyword">if</span> (targetElement) {
        <span class="hljs-keyword">this</span>.removeTargetElement(targetElement);
        <span class="hljs-keyword">this</span>.addTargetElement(targetElement);
      }
    }
  }
}

<span class="hljs-keyword">if</span> (!customElements.<span class="hljs-keyword">get</span>(<span class="hljs-string">&#x27;x-ambience&#x27;</span>)) {
  customElements.define(<span class="hljs-string">&#x27;x-ambience&#x27;</span>, Ambience);
}

export default Ambience;</code></pre>
    </div>
  </div>
</main>

    <div class="footer">
      <div class="center">
        Powered by <a target="_blank" href="https://benignware.com">Benignware</a>
      </div>
    </div>
  </body>
</html>