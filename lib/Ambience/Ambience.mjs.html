<html>
  <head>
    <base href="../.."/>
    <title>x-elements - Ambience.mjs</title>

    <link rel="stylesheet" href="public/github-markdown.min-05fea8df8ec68cb6c27337f6db65733e.css">
    <link rel="stylesheet" href="public/highlight-c281e701b2830b095c67417cd9a7b210.css">
    <link rel="stylesheet" href="public/style-aea3468ccb7ee0c3c4c2b5d339fc989e.css">
    <link rel="stylesheet" href="public/all-cc69a8b8824029ae06797ee01a3cc5c8.css">
    <!-- <link rel="stylesheet" href="public/400-778daa1066fcc9c181a5d4dec3c4b74e.css"> -->

    <!-- <style>
      @font-face {
        font-family: "EmojiSymbols";
        src: url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.eot");
        src: url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.eot?#iefix")format("embedded-opentype"),
        url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.woff2")format("woff2"),
        url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.woff")format("woff"),
        url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.ttf")format("truetype"),
        url("https://db.onlinewebfonts.com/t/5b026bf0b879e4356472ed8c36dc48c7.svg#EmojiSymbols-Regular")format("svg");
      }

    </style> -->

    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" /> -->
    <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/segoe-fonts@1.0.1/segoe-fonts.min.css"> -->

    <!-- <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Emoji:wght@300..700&display=swap" rel="stylesheet"> -->

    <script src="public/plugins/core/example/ExampleViewer.js"></script>
              <script type="importmap">
              {
                "imports": {
                  "x-elements": "./public/index.mjs"
                }
              }
            </script>
              <script src="public/index.mjs" type="module"></script>
            
  </head>
  <body class="markdown-body flex-column">
    <div class="header flex">
      <a class="header-brand" href="./index.html">x-elements</a>
      
<ul class="menu flex align-center justify-center">
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Select.html"
        
        
          role="button"
          
          aria-expanded="false"
        
      >
        Components
      </a>
      
    </li>
    
  
</ul>
      <nav class="links">
        
          
            
              <a href="https://github.com/benignware-labs/x-elements.git">
                
                <i class="fa-brands fa-github"></i>
                <!--<label>github</label>-->
              </a>
            
          
        
      </nav>
    </div>
      
      

<main class="flex-grow flex h-100">
  <div class="sidebar sidebar-left border-right mr-2 flex-noshrink">
  
<ul class="menu">
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Select.html"
        
        
          role="button"
          
          aria-expanded="false"
        
      >
        Components
      </a>
      
        
<ul class="menu">
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Select.html"
        
        
      >
        Select
      </a>
      
    </li>
    
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Preloader.html"
        
        
      >
        Preloader
      </a>
      
    </li>
    
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Panel.html"
        
        
      >
        Panel
      </a>
      
    </li>
    
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/MediaControls.html"
        
        
      >
        MediaControls
      </a>
      
    </li>
    
  
    
    <li class="menu-item">
      <a 
        class="menu-link"
        
          href="components/Ambience.html"
        
        
      >
        Ambience
      </a>
      
    </li>
    
  
</ul>
      
    </li>
    
  
</ul>
</div>
  <div class="flex-grow">
    <div class="container py-4">
      <h1>Source: Ambience.mjs</h1>
      <p>
        lib/Ambience/Ambience.mjs
      </p>
      
      <pre><code class="hljs"><span class="hljs-keyword">const</span> MEDIA_TAGS = [<span class="hljs-string">&#x27;IMG&#x27;</span>, <span class="hljs-string">&#x27;VIDEO&#x27;</span>];

<span class="hljs-comment">// Copy computed styles from another element</span>
function copyStyles(dest, src, props = []) {
  <span class="hljs-keyword">const</span> srcStyle = window.getComputedStyle(src);
  <span class="hljs-keyword">const</span> destStyle = window.getComputedStyle(dest);


  <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>; i &lt; srcStyle.length; i++) {
    <span class="hljs-keyword">const</span> property = srcStyle.item(i);

    <span class="hljs-keyword">if</span> (!props.length || props.includes(property)) {
      <span class="hljs-keyword">const</span> fresh = srcStyle.getPropertyValue(property);
      <span class="hljs-keyword">const</span> current = destStyle.getPropertyValue(property);

      <span class="hljs-keyword">if</span> (fresh !== current) {
        dest.style.setProperty(property, fresh)
      }
    }
  }
}

<span class="hljs-keyword">const</span> getScrollParent = (element, stop = <span class="hljs-literal">null</span>, values = [<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-string">&#x27;auto&#x27;</span>]) =&gt; {
  let parent = element;

  <span class="hljs-keyword">while</span> (parent) {
    <span class="hljs-keyword">if</span> (parent === document.body) {
      <span class="hljs-keyword">return</span> parent;
    }

    <span class="hljs-keyword">if</span> (parent === stop) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-keyword">const</span> style = window.getComputedStyle(parent);

    <span class="hljs-keyword">if</span> (values.includes(style.overflow) || values.includes(style.overflowX) || values.includes(style.overflowY)) {
      <span class="hljs-keyword">return</span> parent;
    } <span class="hljs-keyword">else</span> {
      parent = parent.parentElement;
    }
  }

  <span class="hljs-keyword">return</span> document.body;
};

<span class="hljs-keyword">const</span> getScrollParents = (element, stop = <span class="hljs-literal">null</span>, values = [<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-string">&#x27;auto&#x27;</span>]) =&gt; {
  stop = Array.isArray(stop) ? stop : [stop];

  let parent = element.parentNode;

  <span class="hljs-keyword">const</span> parents = [];

  <span class="hljs-keyword">while</span> (parent) {
    <span class="hljs-keyword">const</span> style = window.getComputedStyle(parent);

    <span class="hljs-keyword">if</span> (values.includes(style.overflow) || values.includes(style.overflowX) || values.includes(style.overflowY)) {
      parents.push(parent);
    }

    <span class="hljs-keyword">if</span> (parent === document.body || stop.includes(parent)) {
      <span class="hljs-keyword">return</span> parents;
    }
    
    parent = parent.parentElement;
  }

  <span class="hljs-keyword">return</span> parents;
};

<span class="hljs-keyword">const</span> getScrollSize = (element) =&gt; {
  let container = element;

  <span class="hljs-keyword">if</span> (element === document.body) {
    container = document.documentElement;
  }

  <span class="hljs-keyword">const</span> size = {
    width: container.scrollWidth,
    height: container.scrollHeight
  };

  <span class="hljs-keyword">return</span> size;
};


<span class="hljs-keyword">const</span> getPositioonFixedParent = (element) =&gt; {
  let parent = element;

  <span class="hljs-keyword">while</span> (parent) {
    <span class="hljs-keyword">const</span> style = window.getComputedStyle(parent);

    <span class="hljs-keyword">if</span> (style.position === <span class="hljs-string">&#x27;fixed&#x27;</span>) {
      <span class="hljs-keyword">return</span> parent;
    } <span class="hljs-keyword">else</span> {
      parent = parent.parentElement;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Ambience</span> <span class="hljs-title">extends</span> <span class="hljs-title">HTMLElement</span> {
  #internals;
  #slot;

  #assignedChildren = new Set();
  #mutationObservers = new WeakMap();
  #mediaElements = new Set();

  #clippingTargets = new Set();
  #clippingParents = new WeakMap();
  
  #clippingDisplayElements = new WeakMap();
  #displayElements = new WeakMap();
  #displayMediaElements = new WeakMap();
  #displayIds = new WeakMap();
  #displayIdInc = <span class="hljs-number">0</span>;

  #animatedElements = new Set();
  #elementAnimations = new WeakMap();

  #scrollParent = <span class="hljs-literal">null</span>;

  #backdrop;
  #backdropBody;

  <span class="hljs-comment">// Props</span>
  #animated = <span class="hljs-literal">false</span>;
  #<span class="hljs-keyword">for</span> = <span class="hljs-literal">null</span>;

  static observedAttributes = [<span class="hljs-string">&#x27;for&#x27;</span>, <span class="hljs-string">&#x27;animated&#x27;</span>];

  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">super</span>();

    <span class="hljs-keyword">this</span>.handleMutation = <span class="hljs-keyword">this</span>.handleMutation.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handleSlotChange = <span class="hljs-keyword">this</span>.handleSlotChange.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handleResize = <span class="hljs-keyword">this</span>.handleResize.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handleLoad = <span class="hljs-keyword">this</span>.handleLoad.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handleScroll = <span class="hljs-keyword">this</span>.handleScroll.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handlePlay = <span class="hljs-keyword">this</span>.handlePlay.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handlePause = <span class="hljs-keyword">this</span>.handlePause.bind(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">this</span>.handleStateChange = <span class="hljs-keyword">this</span>.handleStateChange.bind(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">this</span>.#internals = <span class="hljs-keyword">this</span>.attachInternals();
    <span class="hljs-keyword">this</span>.attachShadow({ mode: <span class="hljs-string">&#x27;open&#x27;</span> });

    <span class="hljs-keyword">this</span>.shadowRoot.innerHTML = `
      &lt;style&gt;
        <span class="hljs-comment">/* Add your styling here */</span>
        :host {
          display: contents;
          --x-ambience-filter--default: contrast(<span class="hljs-number">1.3</span>) blur(<span class="hljs-number">5.</span>5rem) brightness(<span class="hljs-number">1.4</span>) opacity(<span class="hljs-number">0.7</span>);
          <span class="hljs-comment">/*--x-ambience-filter--default: contrast(4) blur(3.5rem) brightness(2.7);*/</span>
          <span class="hljs-comment">/*--x-ambience-filter--default: drop-shadow(0 0 0.75rem crimson);*/</span>
          <span class="hljs-comment">/*--x-ambience-filter--default: none;*/</span>
          --x-ambience-filter--default: blur(<span class="hljs-number">3.</span>5rem);
          --x-ambience-scale--default: <span class="hljs-number">1</span>;
        }

        :host::part(backdrop) {
          position: absolute;
          transform-style: preserve-<span class="hljs-number">3d</span>;
          pointer-events: none;
        }

        :host::part(backdrop-body) {
          position: absolute;
        }

        :host-context(.x-ambience-scroll-measure)::part(backdrop) {
          display: none !important;
          transform: none !important;
        }

         <span class="hljs-comment">/*:host::part(backdrop):after {
          content: &#x27;&#x27;;
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          z-index: 1000;
        }*/</span>

        :host(*) {
          transform-style: preserve-<span class="hljs-number">3d</span>;
          backface-visibility: hidden;
        }

        :host::part(clip) {
          position: absolute;
          overflow: hidden;
          <span class="hljs-comment">/* clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%);*/</span>
        }

        .effect {
          filter: <span class="hljs-keyword">var</span>(--x-ambience-filter, <span class="hljs-keyword">var</span>(--x-ambience-filter--default));
          <span class="hljs-comment">/*scale: var(--x-ambience-scale, var(--x-ambience-scale--default));
          scale: 1;*/</span>
        }

        :host::part(display) {
          position: absolute;
          opacity: <span class="hljs-number">0</span>;
          transition: opacity <span class="hljs-number">0.</span>125s;
          will-change: opacity;
        }

        :host::part(display ready) {
          opacity: <span class="hljs-number">1</span>;
        }
      &lt;/style&gt;
      &lt;div part=<span class="hljs-string">&quot;backdrop&quot;</span>&gt;
        &lt;div part=<span class="hljs-string">&quot;backdrop-body&quot;</span>&gt;&lt;/div&gt;
      &lt;/div&gt;
      &lt;slot&gt;&lt;/slot&gt;
    `;

    <span class="hljs-keyword">this</span>.#backdrop = <span class="hljs-keyword">this</span>.shadowRoot.querySelector(<span class="hljs-string">&#x27;[part=&quot;backdrop&quot;]&#x27;</span>);
    <span class="hljs-keyword">this</span>.#backdropBody = <span class="hljs-keyword">this</span>.shadowRoot.querySelector(<span class="hljs-string">&#x27;[part=&quot;backdrop-body&quot;]&#x27;</span>);
    <span class="hljs-keyword">this</span>.#slot = <span class="hljs-keyword">this</span>.shadowRoot.querySelector(<span class="hljs-string">&#x27;slot&#x27;</span>);
  }

  isMediaElement(element) {
    <span class="hljs-keyword">const</span> isMediaTag = MEDIA_TAGS.includes(element.nodeName);

    <span class="hljs-keyword">if</span> (!isMediaTag) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">const</span> parentAmbience = element.closest(<span class="hljs-string">&#x27;x-ambience&#x27;</span>);

    <span class="hljs-keyword">if</span> (parentAmbience &amp;&amp; parentAmbience !== <span class="hljs-keyword">this</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">const</span> forAmbiences = document.querySelectorAll(`x-ambience[<span class="hljs-keyword">for</span>]`);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> ambience of forAmbiences) {
      <span class="hljs-keyword">if</span> (ambience.getAttribute(<span class="hljs-string">&#x27;for&#x27;</span>) === element.id &amp;&amp; ambience !== <span class="hljs-keyword">this</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  handleMutation(mutations) {
    mutations.forEach((mutation) =&gt; {
      <span class="hljs-keyword">const</span> addedMediaElements = [...mutation.addedNodes]
        .filter(node =&gt; node.nodeType === <span class="hljs-number">1</span> &amp;&amp; MEDIA_TAGS.includes(node.nodeName))
      
      <span class="hljs-keyword">this</span>.mediaElementAdded(...addedMediaElements)

      <span class="hljs-keyword">const</span> removedMediaElements = [...mutation.removedNodes]
        .filter(node =&gt; node.nodeType === <span class="hljs-number">1</span> &amp;&amp; MEDIA_TAGS.includes(node.nodeName))
      
      <span class="hljs-keyword">this</span>.mediaElementRemoved(...removedMediaElements)
      
      <span class="hljs-keyword">if</span> (addedMediaElements.length || removedMediaElements.length) {
        <span class="hljs-keyword">this</span>.render();
      }
    });
  }

  getDisplayId(element) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.#displayIds.has(element)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#displayIds.<span class="hljs-keyword">get</span>(element);
    }
    
    <span class="hljs-keyword">const</span> nextId = <span class="hljs-keyword">this</span>.#displayIdInc++;

    <span class="hljs-keyword">this</span>.#displayIds.<span class="hljs-keyword">set</span>(element, nextId);

    <span class="hljs-keyword">return</span> nextId;
  }

  createDisplayElement(element) {
    <span class="hljs-keyword">const</span> displayElement = document.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);

    <span class="hljs-keyword">const</span> slot = displayElement;

    <span class="hljs-comment">// const slot = document.createElement(&#x27;div&#x27;);</span>
    <span class="hljs-comment">// const slot = document.createElement(&#x27;slot&#x27;);</span>
    <span class="hljs-comment">// const slotId = this.getDisplayId(element);</span>
    
    <span class="hljs-comment">// slot.setAttribute(&#x27;name&#x27;, &#x27;display-&#x27; + slotId);</span>

    <span class="hljs-comment">// displayElement.appendChild(slot);</span>

    let mediaDisplayElement;
  
    <span class="hljs-keyword">if</span> (element instanceof HTMLMediaElement) {
      <span class="hljs-keyword">const</span> canvas = document.createElement(<span class="hljs-string">&#x27;canvas&#x27;</span>);
      <span class="hljs-keyword">const</span> poster = document.createElement(<span class="hljs-string">&#x27;img&#x27;</span>);

      poster.src = element.poster;
      poster.style.width = <span class="hljs-string">&#x27;100%&#x27;</span>;
      poster.style.height = <span class="hljs-string">&#x27;100%&#x27;</span>;
      poster.style.position = <span class="hljs-string">&#x27;absolute&#x27;</span>;

      canvas.style.width = <span class="hljs-string">&#x27;100%&#x27;</span>;
      canvas.style.height = <span class="hljs-string">&#x27;100%&#x27;</span>;
      canvas.style.position = <span class="hljs-string">&#x27;absolute&#x27;</span>;
      
      slot.appendChild(canvas);
      slot.appendChild(poster);

      mediaDisplayElement = canvas;

      
    } <span class="hljs-keyword">else</span> {
      mediaDisplayElement = element.cloneNode(<span class="hljs-literal">true</span>);

      slot.appendChild(mediaDisplayElement);
    }

    <span class="hljs-keyword">this</span>.#displayMediaElements.<span class="hljs-keyword">set</span>(element, mediaDisplayElement);

    <span class="hljs-keyword">this</span>.updateMediaElementStyles(element);

    displayElement.classList.add(<span class="hljs-string">&#x27;display&#x27;</span>);
    displayElement.setAttribute(<span class="hljs-string">&#x27;part&#x27;</span>, <span class="hljs-string">&#x27;display&#x27;</span>);

    <span class="hljs-keyword">return</span> displayElement;
  }

  clippingTargetAdded(element,) {
    element.addEventListener(<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-keyword">this</span>.handleScroll, { passive: <span class="hljs-literal">true</span> });
  }

  clippingTargetRemoved(element) {
    element.removeEventListener(<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-keyword">this</span>.handleScroll, { passive: <span class="hljs-literal">true</span> });

    <span class="hljs-keyword">this</span>.#clippingDisplayElements.delete(element);
  }

  createClippingDisplayElement(element) {
    <span class="hljs-keyword">const</span> clippingDisplayElement = document.createElement(<span class="hljs-string">&#x27;div&#x27;</span>);

    clippingDisplayElement.setAttribute(<span class="hljs-string">&#x27;part&#x27;</span>, <span class="hljs-string">&#x27;clip&#x27;</span>);
    clippingDisplayElement.setAttribute(<span class="hljs-string">&#x27;data-class&#x27;</span>, element.getAttribute(<span class="hljs-string">&#x27;class&#x27;</span>));
    clippingDisplayElement.setAttribute(<span class="hljs-string">&#x27;data-tag&#x27;</span>, element.tagName);

    <span class="hljs-keyword">return</span> clippingDisplayElement;
  }


  mediaElementAdded(...element) {
    <span class="hljs-keyword">const</span> targetElements = [...<span class="hljs-keyword">this</span>.#assignedChildren];

    element.forEach(element =&gt; {
      <span class="hljs-keyword">this</span>.#mediaElements.add(element);

      <span class="hljs-keyword">const</span> scrollParents = getScrollParents(element, targetElements, [<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-string">&#x27;auto&#x27;</span>, <span class="hljs-string">&#x27;hidden&#x27;</span>, <span class="hljs-string">&#x27;clip&#x27;</span>]);

      scrollParents
        .reverse()
        .forEach((scrollParent, index, array) =&gt; {
          <span class="hljs-keyword">const</span> parent = index &gt; <span class="hljs-number">0</span> ? array[index - <span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>;

          <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.#clippingTargets.has(scrollParent)) {
            <span class="hljs-keyword">this</span>.#clippingTargets.add(scrollParent);

            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.#clippingDisplayElements.<span class="hljs-keyword">get</span>(scrollParent)) {
              <span class="hljs-keyword">const</span> clippingDisplayElement = <span class="hljs-keyword">this</span>.createClippingDisplayElement(scrollParent);

              clippingDisplayElement.classList.toggle(<span class="hljs-string">&#x27;effect&#x27;</span>, !parent);

              <span class="hljs-keyword">const</span> displayParent = <span class="hljs-keyword">this</span>.#clippingDisplayElements.<span class="hljs-keyword">get</span>(parent) || <span class="hljs-keyword">this</span>.#backdropBody;
  
              displayParent.appendChild(clippingDisplayElement);
  
              <span class="hljs-keyword">this</span>.#clippingDisplayElements.<span class="hljs-keyword">set</span>(scrollParent, clippingDisplayElement);
              <span class="hljs-keyword">this</span>.#clippingParents.<span class="hljs-keyword">set</span>(scrollParent, parent);
            }

            <span class="hljs-keyword">this</span>.clippingTargetAdded(scrollParent);
          }
        });

      <span class="hljs-keyword">const</span> scrollParent = scrollParents.length ? scrollParents[scrollParents.length - <span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>;
      <span class="hljs-keyword">const</span> displayParent = <span class="hljs-keyword">this</span>.#clippingDisplayElements.<span class="hljs-keyword">get</span>(scrollParent) || <span class="hljs-keyword">this</span>.#backdropBody;
      <span class="hljs-keyword">const</span> displayElement = <span class="hljs-keyword">this</span>.createDisplayElement(element);

      displayElement.classList.toggle(<span class="hljs-string">&#x27;effect&#x27;</span>, !scrollParent);

      <span class="hljs-keyword">this</span>.#displayElements.<span class="hljs-keyword">set</span>(element, displayElement);
      <span class="hljs-keyword">this</span>.#clippingParents.<span class="hljs-keyword">set</span>(element, scrollParent);

      displayParent.appendChild(displayElement);
  
      <span class="hljs-comment">// Load</span>
      element.addEventListener(<span class="hljs-string">&#x27;loadeddata&#x27;</span>, <span class="hljs-keyword">this</span>.handleLoad, { passive: <span class="hljs-literal">true</span> });
      element.addEventListener(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-keyword">this</span>.handleLoad, { passive: <span class="hljs-literal">true</span> });
      <span class="hljs-comment">// Play</span>
      element.addEventListener(<span class="hljs-string">&#x27;play&#x27;</span>, <span class="hljs-keyword">this</span>.handlePlay, { passive: <span class="hljs-literal">true</span> });
      <span class="hljs-comment">// Pause</span>
      element.addEventListener(<span class="hljs-string">&#x27;pause&#x27;</span>, <span class="hljs-keyword">this</span>.handlePause, { passive: <span class="hljs-literal">true</span> });
      

      <span class="hljs-keyword">if</span> (element instanceof HTMLMediaElement) {
        <span class="hljs-keyword">const</span> posterImage = displayElement.querySelector(<span class="hljs-string">&#x27;img&#x27;</span>);

        <span class="hljs-keyword">if</span> (posterImage) {
          posterImage.src = element.poster;

          posterImage.addEventListener(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-keyword">this</span>.handleLoad, { passive: <span class="hljs-literal">true</span> });
        }
      }
    });

    <span class="hljs-keyword">this</span>.mediaElementsChanged();
  }

  mediaElementRemoved(...element) {
    element.forEach(element =&gt; {
      <span class="hljs-comment">// Load</span>
      element.removeEventListener(<span class="hljs-string">&#x27;loadeddata&#x27;</span>, <span class="hljs-keyword">this</span>.handleLoad);
      element.removeEventListener(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-keyword">this</span>.handleLoad);
      <span class="hljs-comment">// Play</span>
      element.removeEventListener(<span class="hljs-string">&#x27;play&#x27;</span>, <span class="hljs-keyword">this</span>.handlePlay);
      <span class="hljs-comment">// Pause</span>
      element.removeEventListener(<span class="hljs-string">&#x27;pause&#x27;</span>, <span class="hljs-keyword">this</span>.handlePause);
     

      <span class="hljs-keyword">const</span> displayElement = <span class="hljs-keyword">this</span>.#displayElements.<span class="hljs-keyword">get</span>(element);

      <span class="hljs-keyword">if</span> (element instanceof HTMLMediaElement) {
        <span class="hljs-keyword">const</span> posterImage = displayElement.querySelector(<span class="hljs-string">&#x27;img&#x27;</span>);

        <span class="hljs-keyword">if</span> (posterImage) {
          posterImage.removeEventListener(<span class="hljs-string">&#x27;load&#x27;</span>, <span class="hljs-keyword">this</span>.handleLoad, { passive: <span class="hljs-literal">true</span> });
        }
      }

      displayElement.parentNode.removeChild(displayElement);
      
      <span class="hljs-keyword">this</span>.#displayElements.delete(element);
      <span class="hljs-keyword">this</span>.#clippingParents.delete(element);

      <span class="hljs-keyword">this</span>.#mediaElements.delete(element);
    });

    <span class="hljs-keyword">this</span>.mediaElementsChanged();
  }

  addTargetElement(...elements) {
    <span class="hljs-keyword">const</span> addedMediaElements = [];
  
    elements
      .filter(element =&gt; !<span class="hljs-keyword">this</span>.#assignedChildren.has(element))
      .forEach(element =&gt; {
        <span class="hljs-keyword">this</span>.#assignedChildren.add(element);
        <span class="hljs-keyword">const</span> mutationObserver = new MutationObserver(<span class="hljs-keyword">this</span>.handleMutation);
        
        mutationObserver.observe(element, {
          childList: <span class="hljs-literal">true</span>,
          subtree: <span class="hljs-literal">true</span>
        });

        <span class="hljs-keyword">this</span>.#mutationObservers.<span class="hljs-keyword">set</span>(element, mutationObserver);

        element.addEventListener(<span class="hljs-string">&#x27;animationstart&#x27;</span>, <span class="hljs-keyword">this</span>.handlePlay, { passive: <span class="hljs-literal">true</span> });
        element.addEventListener(<span class="hljs-string">&#x27;transitionstart&#x27;</span>, <span class="hljs-keyword">this</span>.handlePlay, { passive: <span class="hljs-literal">true</span> });
        element.addEventListener(<span class="hljs-string">&#x27;animationend&#x27;</span>, <span class="hljs-keyword">this</span>.handlePause, { passive: <span class="hljs-literal">true</span> });
        element.addEventListener(<span class="hljs-string">&#x27;transitionend&#x27;</span>, <span class="hljs-keyword">this</span>.handlePause, { passive: <span class="hljs-literal">true</span> });

        <span class="hljs-comment">// Generic state change</span>
        element.addEventListener(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">this</span>.handleStateChange, { passive: <span class="hljs-literal">true</span> });
        element.addEventListener(<span class="hljs-string">&#x27;pointerover&#x27;</span>, <span class="hljs-keyword">this</span>.handleStateChange, { passive: <span class="hljs-literal">true</span> });
        element.addEventListener(<span class="hljs-string">&#x27;pointerenter&#x27;</span>, <span class="hljs-keyword">this</span>.handleStateChange, { passive: <span class="hljs-literal">true</span> });
        element.addEventListener(<span class="hljs-string">&#x27;pointerleave&#x27;</span>, <span class="hljs-keyword">this</span>.handleStateChange, { passive: <span class="hljs-literal">true</span> });
      
        <span class="hljs-keyword">const</span> nodes = [...element.querySelectorAll(MEDIA_TAGS.join(<span class="hljs-string">&#x27;, &#x27;</span>))];
        
        <span class="hljs-keyword">if</span> (MEDIA_TAGS.includes(element.nodeName)) {
          nodes.push(element);
        }
        
        addedMediaElements.push(...nodes);
      });

    <span class="hljs-keyword">this</span>.mediaElementAdded(...addedMediaElements);
  }

  removeTargetElement(...elements) {
    <span class="hljs-keyword">const</span> removedMediaElements = [];

    elements
      .filter(element =&gt; <span class="hljs-keyword">this</span>.#assignedChildren.has(element))
      .forEach(element =&gt; {
        <span class="hljs-keyword">const</span> mutationObserver = <span class="hljs-keyword">this</span>.#mutationObservers.<span class="hljs-keyword">get</span>(element);

        mutationObserver.disconnect();

        <span class="hljs-keyword">this</span>.#mutationObservers.delete(element);

        element.removeEventListener(<span class="hljs-string">&#x27;animationstart&#x27;</span>, <span class="hljs-keyword">this</span>.handlePlay);
        element.removeEventListener(<span class="hljs-string">&#x27;transitionstart&#x27;</span>, <span class="hljs-keyword">this</span>.handlePlay);
        element.removeEventListener(<span class="hljs-string">&#x27;animationend&#x27;</span>, <span class="hljs-keyword">this</span>.handlePause);
        element.removeEventListener(<span class="hljs-string">&#x27;transitionend&#x27;</span>, <span class="hljs-keyword">this</span>.handlePause);

        element.removeEventListener(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">this</span>.handleStateChange);
        element.removeEventListener(<span class="hljs-string">&#x27;pointerover&#x27;</span>, <span class="hljs-keyword">this</span>.handleStateChange);
        element.removeEventListener(<span class="hljs-string">&#x27;pointerenter&#x27;</span>, <span class="hljs-keyword">this</span>.handleStateChange);
        element.removeEventListener(<span class="hljs-string">&#x27;pointerleave&#x27;</span>, <span class="hljs-keyword">this</span>.handleStateChange);

        <span class="hljs-keyword">this</span>.#assignedChildren.delete(element);

        <span class="hljs-keyword">if</span> (MEDIA_TAGS.includes(element.nodeName)) {
          removedMediaElements.push(element);
        }
      });

    <span class="hljs-keyword">this</span>.mediaElementRemoved(...removedMediaElements);
  }

  removeAllTargetElements() {
    <span class="hljs-keyword">this</span>.removeTargetElement(...<span class="hljs-keyword">this</span>.#assignedChildren);
  }

  handleSlotChange(e) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasAttribute(<span class="hljs-string">&#x27;for&#x27;</span>)) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> slot = e.target;
    <span class="hljs-keyword">const</span> assignedElements = [...<span class="hljs-keyword">this</span>.#assignedChildren];
    <span class="hljs-keyword">const</span> removedNodes = assignedElements.filter(x =&gt; !slot.assignedElements().includes(x));
    <span class="hljs-keyword">const</span> addedNodes = slot.assignedElements().filter(x =&gt; !assignedElements.includes(x));

    <span class="hljs-keyword">this</span>.addTargetElement(...addedNodes);
    <span class="hljs-keyword">this</span>.removeTargetElement(...removedNodes);
    <span class="hljs-keyword">this</span>.targetElementsChanged();
  }

  handleScroll(event) {
    <span class="hljs-keyword">this</span>.render();
  }

  handleResize() {
    <span class="hljs-keyword">this</span>.render();
  }

  handleLoad(event) {
    window.requestAnimationFrame(() =&gt; {
      <span class="hljs-keyword">this</span>.render();
    });
  }

  handleStateChange(event) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.#mediaElements.has(event.target)) {
      <span class="hljs-keyword">this</span>.updateMediaElementStyles(event.target);
    }

    <span class="hljs-keyword">this</span>.render();
  }

  startAnimation(element, id) {
    let elementAnimations;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.#elementAnimations.has(element)) {
      elementAnimations = <span class="hljs-keyword">this</span>.#elementAnimations.<span class="hljs-keyword">get</span>(element);
      elementAnimations.add(id);
    } <span class="hljs-keyword">else</span> {
      elementAnimations = new Set();
      elementAnimations.add(id);

      <span class="hljs-keyword">this</span>.#elementAnimations.<span class="hljs-keyword">set</span>(element, elementAnimations);
    }

    <span class="hljs-keyword">this</span>.#animatedElements.add(element);

    <span class="hljs-keyword">this</span>.animate();
  }

  endAnimation(element, id) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.#elementAnimations.has(element)) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> elementAnimations = <span class="hljs-keyword">this</span>.#elementAnimations.<span class="hljs-keyword">get</span>(element);

    elementAnimations.delete(id);
  
    <span class="hljs-keyword">if</span> (elementAnimations.size === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">this</span>.#elementAnimations.delete(element);
      <span class="hljs-keyword">this</span>.#animatedElements.delete(element);
    }
  }

  getAnimationId(event) {
    <span class="hljs-keyword">if</span> (event.type === <span class="hljs-string">&#x27;play&#x27;</span> || event.type === <span class="hljs-string">&#x27;pause&#x27;</span>) {
      <span class="hljs-keyword">return</span> `playback`;
    }

    <span class="hljs-keyword">if</span> (event.type === <span class="hljs-string">&#x27;animationstart&#x27;</span> || event.type === <span class="hljs-string">&#x27;animationend&#x27;</span>) {
      <span class="hljs-keyword">return</span> `animation-${event.animationName}`;
    }

    <span class="hljs-keyword">if</span> (event.type === <span class="hljs-string">&#x27;transitionstart&#x27;</span> || event.type === <span class="hljs-string">&#x27;transitionend&#x27;</span>) {
      <span class="hljs-keyword">return</span> `transition-${event.propertyName}`;
    }
  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  }

  handlePlay(event) {
    <span class="hljs-keyword">this</span>.startAnimation(event.target, <span class="hljs-keyword">this</span>.getAnimationId(event))
  }

  handlePause(event) {
    <span class="hljs-keyword">this</span>.endAnimation(event.target, <span class="hljs-keyword">this</span>.getAnimationId(event))
  }

  isAnimating() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#animated || <span class="hljs-keyword">this</span>.#elementAnimations.size &gt; <span class="hljs-number">0</span>;
  }

  <span class="hljs-keyword">set</span> animated(value) {
    <span class="hljs-keyword">this</span>.#animated = value;
    
    <span class="hljs-keyword">this</span>.animate();
  }

  <span class="hljs-keyword">get</span> animated () {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#animated || <span class="hljs-keyword">this</span>.#animatedElements.size &gt; <span class="hljs-number">0</span>;
  }

  animate() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.animated) {
      <span class="hljs-keyword">this</span>.render();
    }

    window.requestAnimationFrame(() =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.animated) {
        <span class="hljs-keyword">this</span>.animate();
      };
    });
  }

  connectedCallback() {
    window.addEventListener(<span class="hljs-string">&#x27;resize&#x27;</span>, <span class="hljs-keyword">this</span>.handleResize, { passive: <span class="hljs-literal">true</span> });

    <span class="hljs-keyword">this</span>.#slot.addEventListener(<span class="hljs-string">&#x27;slotchange&#x27;</span>, <span class="hljs-keyword">this</span>.handleSlotChange);
    

    <span class="hljs-keyword">this</span>.#scrollParent = getScrollParent(<span class="hljs-keyword">this</span>);

    <span class="hljs-keyword">const</span> scrollTarget = <span class="hljs-keyword">this</span>.#scrollParent === document.body ? window : <span class="hljs-keyword">this</span>.#scrollParent;

    scrollTarget.addEventListener(<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-keyword">this</span>.handleScroll, { passive: <span class="hljs-literal">true</span> });

    <span class="hljs-keyword">this</span>.render();
  }

  detachedCallback() {
    window.removeEventListener(<span class="hljs-string">&#x27;resize&#x27;</span>, <span class="hljs-keyword">this</span>.handleResize);
    <span class="hljs-keyword">this</span>.#slot.removeEventListener(<span class="hljs-string">&#x27;slotchange&#x27;</span>, <span class="hljs-keyword">this</span>.handleSlotChange);

    <span class="hljs-keyword">const</span> scrollTarget = <span class="hljs-keyword">this</span>.#scrollParent === document.body ? window : <span class="hljs-keyword">this</span>.#scrollParent;
    
    scrollTarget.removeEventListener(<span class="hljs-string">&#x27;scroll&#x27;</span>, <span class="hljs-keyword">this</span>.handleScroll);
    <span class="hljs-keyword">this</span>.#scrollParent = <span class="hljs-literal">null</span>;
  }

  mediaElementsChanged() {
    <span class="hljs-keyword">this</span>.render();
  }

  targetElementsChanged() {
    <span class="hljs-keyword">this</span>.render();
  }

  getZIndex() {
    <span class="hljs-keyword">const</span> computedStyle = window.getComputedStyle(<span class="hljs-keyword">this</span>.#backdropBody);
    let zIndex = computedStyle.getPropertyValue(<span class="hljs-string">&#x27;--x-ambience-z-index&#x27;</span>);

    <span class="hljs-keyword">if</span> (!zIndex || zIndex === <span class="hljs-string">&#x27;auto&#x27;</span>) {
      zIndex = !!getPositioonFixedParent(<span class="hljs-keyword">this</span>) ? <span class="hljs-string">&#x27;&#x27;</span> : -<span class="hljs-number">1</span>;
    }

    <span class="hljs-keyword">return</span> zIndex;
  }

  updateClippingDisplayElement(element) {
    <span class="hljs-keyword">const</span> clippingDisplayElement = <span class="hljs-keyword">this</span>.#clippingDisplayElements.<span class="hljs-keyword">get</span>(element);

    <span class="hljs-keyword">if</span> (!clippingDisplayElement) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> clippingParent = <span class="hljs-keyword">this</span>.#clippingParents.<span class="hljs-keyword">get</span>(element);
    <span class="hljs-keyword">const</span> parent = clippingParent || <span class="hljs-keyword">this</span>.#backdropBody;

    <span class="hljs-keyword">const</span> clippingArea = element.getBoundingClientRect();
    <span class="hljs-keyword">const</span> targetBounds = parent.getBoundingClientRect();

    <span class="hljs-comment">// const scale = !clippingParent ? &#x27;var(--x-ambience-scale, var(--x-ambience-scale--default))&#x27; : &#x27;1&#x27;;</span>
    <span class="hljs-keyword">const</span> style = clippingDisplayElement.style;

    <span class="hljs-keyword">const</span> left = clippingArea.left - targetBounds.left;
    <span class="hljs-keyword">const</span> top = clippingArea.top - targetBounds.top;

    <span class="hljs-comment">// style.setProperty(&#x27;transform&#x27;, `translate3d(${clippingArea.left - targetBounds.left}px, ${clippingArea.top - targetBounds.top}px, 0) scale(${scale})`);</span>

    <span class="hljs-comment">// const scale = !clippingParent ? &#x27; scale(var(--x-ambience-scale, var(--x-ambience-scale--default))) &#x27; : &#x27;&#x27;;</span>
    <span class="hljs-keyword">const</span> scale = <span class="hljs-string">&#x27;&#x27;</span>;

    style.setProperty(<span class="hljs-string">&#x27;transform&#x27;</span>, `${scale}  translate3d(${left}px, ${top}px, <span class="hljs-number">0</span>) `);

    style.setProperty(<span class="hljs-string">&#x27;width&#x27;</span>, `${clippingArea.width}px`);
    style.setProperty(<span class="hljs-string">&#x27;height&#x27;</span>, `${clippingArea.height}px`);
  }

  updateClippingDisplayElements () {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> element of <span class="hljs-keyword">this</span>.#clippingTargets) {
      <span class="hljs-keyword">this</span>.updateClippingDisplayElement(element);
    }
  }

  isElementReady(element) {
    <span class="hljs-keyword">if</span> (element instanceof HTMLMediaElement) {
      <span class="hljs-keyword">if</span> (element.poster &amp;&amp; element.played.length === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">const</span> displayElement = <span class="hljs-keyword">this</span>.#displayElements.<span class="hljs-keyword">get</span>(element);
        <span class="hljs-keyword">const</span> poster = displayElement.querySelector(<span class="hljs-string">&#x27;img&#x27;</span>);

        <span class="hljs-keyword">return</span> poster.complete;
      }

      <span class="hljs-keyword">return</span> element.readyState &gt;= <span class="hljs-number">3</span>;
    }

    <span class="hljs-keyword">if</span> (element instanceof HTMLImageElement) {
      <span class="hljs-keyword">return</span> element.complete;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  }

  updateMediaElementStyles(element) {
    <span class="hljs-keyword">const</span> mediaDisplayElement = <span class="hljs-keyword">this</span>.#displayMediaElements.<span class="hljs-keyword">get</span>(element);

    <span class="hljs-keyword">if</span> (!mediaDisplayElement) {
      <span class="hljs-keyword">return</span>;
    }

    copyStyles(mediaDisplayElement, element, [
      <span class="hljs-string">&#x27;object-fit&#x27;</span>,
      <span class="hljs-string">&#x27;object-position&#x27;</span>,
      <span class="hljs-string">&#x27;filter&#x27;</span>,
      <span class="hljs-string">&#x27;transform&#x27;</span>,
      <span class="hljs-string">&#x27;transform-origin&#x27;</span>,
      <span class="hljs-string">&#x27;transform-style&#x27;</span>,
      <span class="hljs-string">&#x27;opacity&#x27;</span>,
      <span class="hljs-string">&#x27;position&#x27;</span>,
      <span class="hljs-comment">// &#x27;top&#x27;,</span>
      <span class="hljs-comment">// &#x27;left&#x27;,</span>
      <span class="hljs-comment">// &#x27;right&#x27;,</span>
      <span class="hljs-comment">// &#x27;bottom&#x27;,</span>
      <span class="hljs-string">&#x27;clip-path&#x27;</span>,
    ]);
  }

  updateMediaElement(element) {
    <span class="hljs-keyword">const</span> displayElement = <span class="hljs-keyword">this</span>.#displayElements.<span class="hljs-keyword">get</span>(element);

    <span class="hljs-keyword">if</span> (!displayElement) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> clippingParent = <span class="hljs-keyword">this</span>.#clippingParents.<span class="hljs-keyword">get</span>(element);
    <span class="hljs-keyword">const</span> targetParent = clippingParent || <span class="hljs-keyword">this</span>.#backdropBody;
    <span class="hljs-keyword">const</span> targetBounds = targetParent.getBoundingClientRect();

    <span class="hljs-keyword">const</span> elementBounds = element.getBoundingClientRect();

    <span class="hljs-keyword">const</span> top = elementBounds.top - targetBounds.top;
    <span class="hljs-keyword">const</span> left = elementBounds.left - targetBounds.left;

    <span class="hljs-comment">// const scale = !clippingParent ? &#x27; translate(-50%, -50%) scale(var(--x-ambience-scale, var(--x-ambience-scale--default)))&#x27; : &#x27;&#x27;;</span>
    <span class="hljs-keyword">const</span> scale = <span class="hljs-string">&#x27;  scale(var(--x-ambience-scale, var(--x-ambience-scale--default)))&#x27;</span>;

    <span class="hljs-keyword">const</span> isRenderedBefore = displayElement.style.transform !== <span class="hljs-string">&#x27;&#x27;</span>;

      <span class="hljs-keyword">if</span> (!isRenderedBefore || elementBounds.width &gt; <span class="hljs-number">0</span> &amp;&amp; elementBounds.height &gt; <span class="hljs-number">0</span>) {
        displayElement.style.setProperty(<span class="hljs-string">&#x27;transform&#x27;</span>, `translate3d(${left}px, ${top}px, <span class="hljs-number">0</span>) ${scale} `);
        displayElement.style.setProperty(<span class="hljs-string">&#x27;width&#x27;</span>, `${elementBounds.width}px`);
        displayElement.style.setProperty(<span class="hljs-string">&#x27;height&#x27;</span>, `${elementBounds.height}px`);
        displayElement.style.setProperty(<span class="hljs-string">&#x27;opacity&#x27;</span>, <span class="hljs-number">1</span>);
        displayElement.style.setProperty(<span class="hljs-string">&#x27;display&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>);

      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isRenderedBefore) {
        displayElement.style.setProperty(<span class="hljs-string">&#x27;opacity&#x27;</span>, <span class="hljs-number">0</span>);
        displayElement.style.setProperty(<span class="hljs-string">&#x27;display&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>);
      } <span class="hljs-keyword">else</span> {
        displayElement.style.setProperty(<span class="hljs-string">&#x27;display&#x27;</span>, <span class="hljs-string">&#x27;none&#x27;</span>);
      }

    displayElement.style.setProperty(<span class="hljs-string">&#x27;width&#x27;</span>, `${elementBounds.width}px`);
    displayElement.style.setProperty(<span class="hljs-string">&#x27;height&#x27;</span>, `${elementBounds.height}px`);

    displayElement.setAttribute(<span class="hljs-string">&#x27;part&#x27;</span>, <span class="hljs-keyword">this</span>.isElementReady(element) ? <span class="hljs-string">&#x27;display ready&#x27;</span> : <span class="hljs-string">&#x27;display&#x27;</span>);

    <span class="hljs-keyword">const</span> mediaDisplayElement = <span class="hljs-keyword">this</span>.#displayMediaElements.<span class="hljs-keyword">get</span>(element);

    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Copy styles in a separate state handler</span>
    <span class="hljs-comment">// copyStyles(mediaDisplayElement, element);</span>
    mediaDisplayElement.style.setProperty(<span class="hljs-string">&#x27;visibility&#x27;</span>, window.getComputedStyle(element).visibility);

    mediaDisplayElement.style.setProperty(<span class="hljs-string">&#x27;position&#x27;</span>, <span class="hljs-string">&#x27;absolute&#x27;</span>);
    mediaDisplayElement.style.setProperty(<span class="hljs-string">&#x27;top&#x27;</span>, <span class="hljs-string">&#x27;0&#x27;</span>);
    mediaDisplayElement.style.setProperty(<span class="hljs-string">&#x27;bottom&#x27;</span>, <span class="hljs-string">&#x27;0&#x27;</span>);
    mediaDisplayElement.style.setProperty(<span class="hljs-string">&#x27;transition-duration&#x27;</span>, <span class="hljs-string">&#x27;0s&#x27;</span>);
    mediaDisplayElement.style.setProperty(<span class="hljs-string">&#x27;width&#x27;</span>, `${elementBounds.width}px`);
    mediaDisplayElement.style.setProperty(<span class="hljs-string">&#x27;height&#x27;</span>, `${elementBounds.height}px`);

    <span class="hljs-keyword">if</span> (element instanceof HTMLMediaElement) {
      <span class="hljs-keyword">const</span> canvas = displayElement.querySelector(<span class="hljs-string">&#x27;canvas&#x27;</span>);
      <span class="hljs-keyword">const</span> poster = displayElement.querySelector(<span class="hljs-string">&#x27;img&#x27;</span>);
      
      <span class="hljs-keyword">const</span> isPoster = element.poster &amp;&amp; element.played.length === <span class="hljs-number">0</span>;

      poster.style.setProperty(<span class="hljs-string">&#x27;width&#x27;</span>, `${elementBounds.width}px`);
      poster.style.setProperty(<span class="hljs-string">&#x27;height&#x27;</span>, `${elementBounds.height}px`);
      poster.style.setProperty(<span class="hljs-string">&#x27;object-fit&#x27;</span>, <span class="hljs-string">&#x27;cover&#x27;</span>);
      poster.style.setProperty(<span class="hljs-string">&#x27;display&#x27;</span>, isPoster ? <span class="hljs-string">&#x27;block&#x27;</span> : <span class="hljs-string">&#x27;none&#x27;</span>);

      <span class="hljs-keyword">if</span> (!isPoster) {
        canvas.width = elementBounds.width;
        canvas.height = elementBounds.height;

        <span class="hljs-keyword">const</span> context = canvas.getContext(<span class="hljs-string">&#x27;2d&#x27;</span>);
        context.drawImage(element, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, canvas.width, canvas.height);
      }
    }
  }

  updateMediaElements() {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> element of <span class="hljs-keyword">this</span>.#mediaElements) {
      <span class="hljs-keyword">this</span>.updateMediaElement(element);
    }
  }

  clipToParent() {
    <span class="hljs-keyword">const</span> scrollParent = <span class="hljs-keyword">this</span>.#scrollParent;
    <span class="hljs-keyword">const</span> backdrop = <span class="hljs-keyword">this</span>.#backdrop;
    <span class="hljs-keyword">const</span> backdropBody = <span class="hljs-keyword">this</span>.#backdropBody;

    backdrop.style.transform = ``;
    backdrop.style.width = ``;
    backdrop.style.height = ``;

    <span class="hljs-keyword">const</span> targetBounds = backdrop.getBoundingClientRect();

    scrollParent.classList.add(<span class="hljs-string">&#x27;x-ambience-scroll-measure&#x27;</span>);

    <span class="hljs-keyword">const</span> scrollBounds = scrollParent.getBoundingClientRect();

    <span class="hljs-keyword">const</span> relScrollBounds = {
      top: scrollBounds.top - targetBounds.top,
      left: scrollBounds.left - targetBounds.left,
      right: scrollBounds.right - targetBounds.left,
      bottom: scrollBounds.bottom - targetBounds.top
    };
  
    let { left, top } = relScrollBounds;
    let { width, height } = getScrollSize(scrollParent);

    backdrop.style.transform = `translate3d(${left}px, ${top}px, <span class="hljs-number">0</span>)`;
    backdrop.style.width = `${width}px`;
    backdrop.style.height = `${height}px`;
    backdrop.style.overflow = <span class="hljs-string">&#x27;hidden&#x27;</span>;

    backdrop.style.transform = `translate3d(${left}px, ${top}px, <span class="hljs-number">0</span>)`;

    backdropBody.style.transform = `translate3d(${-left}px, ${-top}px, <span class="hljs-number">0</span>)`;

    scrollParent.classList.remove(<span class="hljs-string">&#x27;x-ambience-scroll-measure&#x27;</span>);
  }

  render() {
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isConnected || !<span class="hljs-keyword">this</span>.parentNode) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.#scrollParent) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.#mediaElements.size === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// this.clipToParent();</span>


    <span class="hljs-keyword">const</span> zIndex = <span class="hljs-keyword">this</span>.getZIndex();

    <span class="hljs-keyword">this</span>.#backdrop.style.setProperty(<span class="hljs-string">&#x27;z-index&#x27;</span>, zIndex);

    <span class="hljs-keyword">this</span>.updateClippingDisplayElements();
    <span class="hljs-keyword">this</span>.updateMediaElements();
  }


  <span class="hljs-keyword">set</span> <span class="hljs-keyword">for</span>(value) {
    <span class="hljs-keyword">if</span> (value !== <span class="hljs-keyword">this</span>.<span class="hljs-keyword">for</span>) {
      <span class="hljs-keyword">if</span> (value) {
        <span class="hljs-keyword">this</span>.setAttribute(<span class="hljs-string">&#x27;for&#x27;</span>, value);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.removeAttribute(<span class="hljs-string">&#x27;for&#x27;</span>);
      }

      <span class="hljs-keyword">this</span>.removeAllTargetElements();

      <span class="hljs-keyword">this</span>.#<span class="hljs-keyword">for</span> = value;

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.#<span class="hljs-keyword">for</span>) {
        <span class="hljs-keyword">const</span> targetElement = document.querySelector(`#${<span class="hljs-keyword">this</span>.#<span class="hljs-keyword">for</span>}`);

        <span class="hljs-keyword">if</span> (targetElement) {
          <span class="hljs-keyword">this</span>.addTargetElement(targetElement);
        }
      }
    }
  }

  <span class="hljs-keyword">get</span> <span class="hljs-keyword">for</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#<span class="hljs-keyword">for</span>;
  }

  attributeChangedCallback(name, oldValue, newValue) {
    <span class="hljs-keyword">if</span> (oldValue === newValue) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (Reflect.has(<span class="hljs-keyword">this</span>, name)) {
      <span class="hljs-keyword">const</span> isBool = typeof (<span class="hljs-keyword">this</span>[name]) === <span class="hljs-string">&#x27;boolean&#x27;</span>;
      <span class="hljs-keyword">const</span> value = isBool ? <span class="hljs-keyword">this</span>.hasAttribute(name) : newValue;

      <span class="hljs-keyword">if</span> (value !== <span class="hljs-keyword">this</span>[name]) {
        <span class="hljs-keyword">this</span>[name] = value;
      }
    }
  }
}

<span class="hljs-keyword">if</span> (!customElements.<span class="hljs-keyword">get</span>(<span class="hljs-string">&#x27;x-ambience&#x27;</span>)) {
  customElements.define(<span class="hljs-string">&#x27;x-ambience&#x27;</span>, Ambience);
}

export default Ambience;</code></pre>
    </div>
  </div>
</main>

    <div class="footer">
      <div class="center">
        Powered by <a target="_blank" href="https://benignware.com">Benignware</a>
      </div>
    </div>
  </body>
</html>